<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Solo Race | Global Circuit</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --neon: #ccff00; --bg: #050505; --turbo: #ff0055; --cyan: #00fbff; --loss: #ff3300; }
        * { touch-action: none; box-sizing: border-box; -webkit-user-select: none; outline: none; }
        
        body { 
            background: var(--bg); 
            color: #fff; 
            margin: 0; 
            padding: 0;
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
        }
        
        #hud { 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(20,20,20,0.9); 
            border-bottom: 1px solid #333; 
            position: relative; 
            z-index: 10; 
            height: 100px;
            flex-shrink: 0;
        }

        .p-box { display: flex; flex-direction: column; min-width: 120px; }
        .name { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #888; margin-bottom: 2px; font-weight: 700; }
        .score-row { display: flex; align-items: baseline; gap: 8px; }
        .score { font-size: 32px; font-weight: 900; line-height: 1; font-variant-numeric: tabular-nums; }
        .high-label { font-size: 9px; color: var(--cyan); opacity: 0.8; }
        
        #goal-tag { 
            display: flex; flex-direction: column; align-items: center; gap: 2px;
            font-size: 10px; color: var(--turbo); border: 1.5px solid var(--turbo); 
            padding: 6px 15px; border-radius: 8px; font-weight: 900; background: rgba(255,0,85,0.05);
        }

        .energy-container { width: 100%; height: 3px; background: #222; margin-top: 5px; border-radius: 1px; overflow: hidden; }
        .energy-fill { height: 100%; width: 0%; background: var(--neon); transition: width 0.3s ease; box-shadow: 0 0 10px var(--neon); }

        #game-area { 
            position: relative; 
            flex-grow: 1; 
            width: 100%; 
            background: #000; 
            overflow: hidden; 
            border-top: 2px solid #222;
        }
        canvas { width: 100%; height: 100%; display: block; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(10px); }
        .modal { width: 90%; max-width: 400px; text-align: center; padding: 30px 20px; border-radius: 24px; background: #111; border: 1px solid #333; }
        h1 { font-size: 32px; margin-bottom: 10px; color: var(--neon); margin-top:0; }
        p { color: #888; font-size: 14px; margin-bottom: 20px; }
        
        input { width: 100%; padding: 18px; background: #000; border: 1px solid #333; color: #fff; border-radius: 12px; font-size: 16px; margin-bottom: 20px; text-align: center; }
        .btn { width: 100%; padding: 18px; background: var(--neon); color: #000; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; text-transform: uppercase; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        #link-box { font-size: 11px; color: var(--cyan); background: #000; padding: 12px; border-radius: 10px; word-break: break-all; margin-top: 15px; border: 1px dashed #444; }
    </style>
</head>
<body>

<div id="hud">
    <div class="p-box">
        <div id="opp-n" class="name">Opponent</div>
        <div class="score-row">
            <div id="opp-s" class="score">0</div>
            <div class="high-label">BEST: <span id="opp-h">0</span></div>
        </div>
        <div class="energy-container"><div id="opp-energy" class="energy-fill" style="background:var(--turbo)"></div></div>
    </div>
    
    <div id="goal-tag">
        <span>GOAL: 50</span>
        <span style="font-size:8px; opacity:0.6">VS MODE</span>
    </div>

    <div class="p-box" style="text-align:right">
        <div id="my-n" class="name">You</div>
        <div class="score-row" style="flex-direction: row-reverse;">
            <div id="my-s" class="score">0</div>
            <div class="high-label">BEST: <span id="my-h">0</span></div>
        </div>
        <div class="energy-container" style="align-self: flex-end;"><div id="my-energy" class="energy-fill"></div></div>
    </div>
</div>

<div id="game-area"><canvas id="game"></canvas></div>

<div id="step-name" class="overlay">
    <div class="modal">
        <h1>NEON PONG</h1>
        <p>Return with the center for <b>PERFECT</b> bonus!<br>Reach 50 to win. <b>-5 = ELIMINATED</b></p>
        <input type="text" id="name-input" placeholder="ENTER NAME">
        <button class="btn" onclick="initGame()">START RACE</button>
    </div>
</div>

<div id="step-share" class="overlay" style="display:none">
    <div class="modal">
        <h2 style="color:var(--neon)">INVITE OPPONENT</h2>
        <div id="link-box">...</div>
        <button class="btn" id="copy-btn" style="margin-top:20px" onclick="copyLink()">COPY LINK</button>
    </div>
</div>

<div id="step-win" class="overlay" style="display:none">
    <div class="modal">
        <h1 id="status-txt">MATCH OVER</h1>
        <p id="winner-detail" style="font-size: 18px; color: #fff;"></p>
        <button class="btn" id="rematch-btn" onclick="requestRematch()">REMATCH</button>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCkpSNJP6-puaQsB9H5ZX_pp9alrbR58lI",
    authDomain: "pinga-8bba9.firebaseapp.com",
    databaseURL: "https://pinga-8bba9-default-rtdb.firebaseio.com",
    projectId: "pinga-8bba9",
    storageBucket: "pinga-8bba9.firebasestorage.app",
    messagingSenderId: "751196556015",
    appId: "1:751196556015:web:504f02ccc79778c41da91a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const area = document.getElementById('game-area');

let highScore = parseInt(localStorage.getItem('neonHighScore')) || 0;
document.getElementById('my-h').innerText = highScore;

window.onload = () => {
    const savedName = localStorage.getItem('neonPlayerName');
    if(savedName) document.getElementById('name-input').value = savedName;
    resize();
};

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, dur, vol=0.08) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
}

let W, H, role, matchRef, gameActive = false;
let myScore = 0, oppScore = 0;
let ball = { x: 0.5, y: 0.2, dx: 0.006, dy: 0.006 };
let myPaddleX = 0.5, lastPaddleX = 0.5, paddleVel = 0;
let trail = [], particles = [], announcements = [];
let wallFlash = 0, shake = 0;
let frameCount = 0;

function resize() { 
    W = canvas.width = area.offsetWidth; 
    H = canvas.height = area.offsetHeight; 
}
window.addEventListener('resize', resize);

function formatName(name) { 
    if(!name) return "PLAYER";
    const up = name.toUpperCase();
    return up.includes("SUMAIYA") ? up + " ðŸ’Ž ðŸ–¤" : up; 
}

function initGame() {
    const name = document.getElementById('name-input').value.trim() || "PLAYER";
    localStorage.setItem('neonPlayerName', name);
    document.getElementById('step-name').style.display = 'none';
    const mId = new URLSearchParams(window.location.search).get('m');
    
    if(mId) {
        role = 'p2';
        matchRef = db.ref("race/" + mId);
        matchRef.update({ p2N: name, p2S: 0, p2H: highScore, p2Ready: false, active: true });
    } else {
        role = 'p1';
        const newId = Math.random().toString(36).substring(2, 7);
        matchRef = db.ref("race/" + newId);
        document.getElementById('link-box').innerText = window.location.origin + window.location.pathname + "?m=" + newId;
        document.getElementById('step-share').style.display = 'flex';
        matchRef.set({ p1N: name, p1S: 0, p1H: highScore, p1Ready: false, p2N: "WAITING...", p2S: 0, p2H: 0, p2Ready: false, active: false });
    }
    startSync();
}

function startSync() {
    matchRef.on('value', snap => {
        const d = snap.val();
        if(!d) return;
        const isP1 = role === 'p1';
        oppScore = isP1 ? d.p2S : d.p1S;
        const oppH = isP1 ? d.p2H : d.p1H;
        
        document.getElementById('opp-n').innerText = formatName(isP1 ? d.p2N : d.p1N);
        document.getElementById('my-n').innerText = formatName(isP1 ? d.p1N : d.p2N);
        document.getElementById('opp-s').innerText = oppScore;
        document.getElementById('opp-h').innerText = oppH || 0;
        document.getElementById('opp-energy').style.width = Math.min(100, Math.max(0, (oppScore/50) * 100)) + "%";

        if (d.p1Ready && d.p2Ready) {
            matchRef.update({ p1Ready: false, p2Ready: false, p1S: 0, p2S: 0 });
            resetLocalGame();
        }
        if(d.active && !gameActive && !d.p1Ready && !d.p2Ready) {
            document.getElementById('step-share').style.display = 'none';
            document.getElementById('step-win').style.display = 'none';
            gameActive = true;
            resize();
            loop();
        }
        if(gameActive && (d.p1S >= 50 || d.p2S >= 50 || d.p1S <= -5 || d.p2S <= -5)) endGame(d);
    });
}

function endGame(d) {
    gameActive = false;
    document.getElementById('step-win').style.display = 'flex';
    let myCurrent = (role === 'p1' ? d.p1S : d.p2S);
    let lostByScore = myCurrent <= -5;
    let winMsg = "";
    
    if (lostByScore) winMsg = "ELIMINATED! (SCORE -5)";
    else if (myCurrent >= 50) winMsg = "CIRCUIT CHAMPION!";
    else winMsg = "MATCH LOST";

    document.getElementById('winner-detail').innerText = winMsg;
}

function requestRematch() {
    document.getElementById('rematch-btn').innerText = "WAITING...";
    const up = {}; up[role + "Ready"] = true;
    matchRef.update(up);
}

function resetLocalGame() {
    myScore = 0; trail = []; particles = []; announcements = [];
    document.getElementById('my-s').innerText = "0";
    document.getElementById('step-win').style.display = 'none';
    document.getElementById('rematch-btn').innerText = "REMATCH";
    resetBall();
    if (!gameActive) { gameActive = true; loop(); }
}

window.addEventListener('pointermove', e => {
    let rect = canvas.getBoundingClientRect();
    lastPaddleX = myPaddleX;
    myPaddleX = (e.clientX - rect.left) / W;
    paddleVel = myPaddleX - lastPaddleX;
    myPaddleX = Math.max(0.1, Math.min(0.9, myPaddleX));
});

function spawnParticles(x, y, color, count=8, speed=10) {
    for(let i=0; i<count; i++) {
        particles.push({ x, y, vx: (Math.random()-0.5)*speed, vy: (Math.random()-0.5)*speed, life: 1.0, color });
    }
}

function announce(txt, color) {
    announcements.push({ txt, color, y: H/2, opacity: 1 });
}

function loop() {
    if(!gameActive) return;
    frameCount++;

    let speedFactor = 1 + (Math.max(0, myScore) * 0.015);
    let zigzag = (myScore > 25) ? Math.sin(frameCount * 0.1) * 0.002 : 0;
    
    ball.x += (ball.dx * speedFactor) + zigzag;
    ball.y += (ball.dy * speedFactor);
    
    trail.push({x: ball.x, y: ball.y});
    if(trail.length > 15) trail.shift();

    if(ball.x < 0.03 || ball.x > 0.97) {
        ball.dx *= -1;
        ball.x = (ball.x < 0.03) ? 0.031 : 0.969;
        wallFlash = 15; shake = 4;
        spawnParticles(ball.x*W, ball.y*H, "var(--cyan)");
        playSound(400, 'sine', 0.05);
    }
    if(ball.y < 0.03) {
        ball.dy *= -1;
        ball.y = 0.031;
        wallFlash = 15;
        playSound(600, 'sine', 0.05);
    }

    let pW = Math.max(0.08, 0.2 - (myScore * 0.002));
    let paddleY = 0.85;
    
    // Fixed: Detect collision only if ball is moving DOWNWARDS to prevent double hits
    if(ball.dy > 0 && ball.y >= paddleY && ball.y <= paddleY + 0.05) {
        let diff = ball.x - myPaddleX;
        if(Math.abs(diff) < pW/2) {
            ball.dy = -Math.abs(ball.dy); 
            ball.y = paddleY - 0.01; 
            ball.dx += (diff * 0.1) + (paddleVel * 0.4); 
            
            if(Math.abs(diff) < 0.02) {
                updateScore(2); // PERFECT BONUS
                announce("PERFECT!", "var(--neon)");
                shake = 10;
                playSound(1200, 'square', 0.2, 0.15);
            } else {
                updateScore(1); // REGULAR HIT
                playSound(800, 'square', 0.1);
            }
            spawnParticles(ball.x*W, ball.y*H, "var(--neon)", 12, 12);
        }
    }

    if(ball.y > 1.0) {
        updateScore(-2);
        shake = 12;
        playSound(150, 'sawtooth', 0.4);
        resetBall();
    }

    draw();
    requestAnimationFrame(loop);
}

function updateScore(val) {
    myScore = myScore + val;
    document.getElementById('my-s').innerText = myScore;
    document.getElementById('my-energy').style.width = Math.min(100, Math.max(0, (myScore/50)*100)) + "%";
    
    const updates = {};
    updates[role + "S"] = myScore;

    if(myScore > highScore) {
        highScore = myScore;
        localStorage.setItem('neonHighScore', highScore.toString());
        document.getElementById('my-h').innerText = highScore;
        updates[role + "H"] = highScore;
    }

    matchRef.update(updates);
}

function resetBall() {
    ball = { x: 0.5, y: 0.2, dx: (Math.random()-0.5)*0.01, dy: 0.008 };
}

function draw() {
    ctx.save();
    if(shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.9; }
    
    ctx.fillStyle = "#050505";
    ctx.fillRect(0,0,W,H);
    
    ctx.strokeStyle = "#111";
    for(let i=0; i<W; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,H); ctx.stroke(); }

    ctx.shadowBlur = wallFlash > 0 ? 20 : 0;
    ctx.shadowColor = "var(--cyan)";
    ctx.fillStyle = wallFlash > 0 ? "#fff" : "#1a1a1a";
    ctx.fillRect(0,0,W,8); ctx.fillRect(0,0,8,H); ctx.fillRect(W-8,0,8,H);
    if(wallFlash > 0) wallFlash--;

    trail.forEach((p, i) => {
        ctx.fillStyle = `hsla(180, 100%, 50%, ${i / trail.length * 0.5})`;
        ctx.beginPath(); ctx.arc(p.x*W, p.y*H, (i/trail.length)*10, 0, Math.PI*2); ctx.fill();
    });

    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.03;
        ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
        ctx.fillRect(p.x, p.y, 4, 4);
    });
    particles = particles.filter(p => p.life > 0);
    ctx.globalAlpha = 1;

    ctx.shadowBlur = 20; ctx.shadowColor = "var(--turbo)";
    ctx.fillStyle = "#fff";
    ctx.beginPath(); ctx.arc(ball.x*W, ball.y*H, 10, 0, Math.PI*2); ctx.fill();

    let pW = Math.max(0.08, 0.2 - (myScore * 0.002)) * W;
    ctx.shadowBlur = 20; ctx.shadowColor = "var(--neon)";
    ctx.fillStyle = "var(--neon)";
    ctx.fillRect(myPaddleX*W - pW/2, H * 0.85, pW, 12);
    
    announcements.forEach((a, i) => {
        ctx.font = "bold 40px 'Segoe UI'";
        ctx.fillStyle = a.color;
        ctx.globalAlpha = a.opacity;
        ctx.textAlign = "center";
        ctx.fillText(a.txt, W/2, a.y);
        a.y -= 1; a.opacity -= 0.02;
    });
    announcements = announcements.filter(a => a.opacity > 0);

    ctx.restore();
}

function copyLink() {
    const text = document.getElementById('link-box').innerText;
    const btn = document.getElementById('copy-btn');
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            btn.innerText = "COPIED!";
            setTimeout(() => btn.innerText = "COPY LINK", 2000);
        }).catch(() => fallbackCopy(text, btn));
    } else {
        fallbackCopy(text, btn);
    }
}

function fallbackCopy(text, btn) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    textArea.setSelectionRange(0, 99999);
    try {
        const successful = document.execCommand('copy');
        btn.innerText = successful ? "COPIED!" : "ERROR";
    } catch (err) {
        btn.innerText = "ERROR";
    }
    document.body.removeChild(textArea);
    setTimeout(() => btn.innerText = "COPY LINK", 2000);
}
</script>
</body>
</html>
